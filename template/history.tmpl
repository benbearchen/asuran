<html>
<head>
<title>{{.Client}}'s history</title>
<style type="text/css">
/* copy from http://www.w3school.com.cn/tiy/t.asp?f=csse_table_fancy */
#profile
  {
  font-family:"Trebuchet MS", Arial, Helvetica, sans-serif;
  border-collapse:collapse;
  }

#profile td, #profile th 
  {
  font-size:1em;
  border:1px solid #98bf21;
  padding:3px 7px 2px 7px;
  min-width:100px;
  }

#profile th 
  {
  font-size:1.1em;
  text-align:left;
  padding-top:5px;
  padding-bottom:4px;
  background-color:#A7C942;
  color:#ffffff;
  }

#profile tr.alt td 
  {
  color:#000000;
  background-color:#EAF2D3;
  }
</style>

<script src="/res/js/external/jquery/jquery.js"></script>
<script src="/res/js/jquery-ui.js"></script>

<script type="text/javascript">
function domainRedirect(domain) {
    alert("暂时未实现重定向 " + domain);
}

function proxyCache(url) {
    alert("暂时未实现缓存 " + url);
}

var lastTime = "{{.LastT}}";

function watchHistory() {
  var data = {};
  if (lastTime != "") {
    data.t = lastTime;
  }

  $.ajax({
    type: "POST",
    url: "/profile/{{.Client}}/history/watch.json",
    dataType: "json",
    data: data,
    success: function(result) {
      if (result.info == "") {
        showHistory(result.history);
      } else if (result.info == "restarted") {
        lastTime = "";
        alert("profile 历史已重启，要看新历史请刷新或重新打开！");
        return;
      }

      watchHistory();
    },
    error: function(data) {
      //alert(data);
      setTimeout(watchHistory, 15000);
    }
  });
}

function showHistory(history) {
  if (history == null || history.length == 0) {
    return;
  }

  var c = $("#profile tr").length;
  for (var i = 0; i != history.length; i++) {
    var h = history[i];
    lastTime = h.t;

    var even = "";
    if ((c + i) % 2 == 0) {
      even = ' class="alt"';
    }

    var ops = "";
    if (h.ops != null && h.ops.length > 0) {
      for (var j = 0; j != h.ops.length; j++) {
         var op = h.ops[j];
         ops += '<a href="/profile/'+op.client+'/'+op.act+'/'+op.arg+'" target="_blank">'+op.name+'<a/>';
      }
    }

    var urlIDBegin = "";
    var urlIDEnd = "";
    var urlIDDetail = "";
    var urlBody = "";
    if (h.url != "") {
      if (h.urlID != "") {
        urlIDBegin = '<a href="/profile/'+h.client+'/look/'+h.urlID+'" target="_blank">';
        urlIDEnd = '</a>';
        urlIDDetail = ' <a href="/profile/'+h.client+'/detail/'+h.urlID+'" target="_blank">HTTP 详情</a> ';
      }

      urlBody = ' <a href="/profile/'+h.client+'/list/'+h.urlBody+'" target="_blank">所有历史</a>';
    }

    $("<tr"+even+"><td>"+ops+"</td><td>"+h.time+"</td><td>"+h.domainIP+h.info+"</td><td>"+h.domain+urlIDBegin+h.url+urlIDEnd+urlIDDetail+urlBody+h.log+"</td></tr>").appendTo("#profile");
  }
}

</script>
</head>
<body>

<table id="profile">
<tr>
<th>操作</th>
<th>时间</th>
<th>值/状态</th>
<th>事件</th>
</tr>
{{range .Events}}
<tr{{if .Even}} class="alt"{{end}}>
<td>{{range .OPs}}<a href="/profile/{{.Client}}/{{.Act}}/{{.Arg}}" target="_blank">{{.Name}}<a/> {{end}}</td>
<td>{{.Time}}</td>
<td>{{.DomainIP}}{{.HttpStatus}}</td>
<td>{{if .Domain}}{{.Domain}}{{end}}{{if .URL}}{{if .URLID}}<a href="/profile/{{.Client}}/look/{{.URLID}}" target="_blank">{{end}}{{.URL}}{{if .URLID}}</a>{{end}} {{if .URLID}}<a href="/profile/{{.Client}}/detail/{{.URLID}}" target="_blank">HTTP 详情</a> {{end}} <a href="/profile/{{.Client}}/list/{{.URLBody}}" target="_blank">所有历史</a>{{end}}{{if .EventString}}{{.EventString}}{{end}}</td>
</tr>
{{end}}
</table>

<script type="text/javascript">
watchHistory(); // auto load new history
</script>

</body>
</html>
